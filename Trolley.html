<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小推車材料天數計算器</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 15px;
    }
    .card {
      max-width: 100%;
      margin: auto;
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      margin-bottom: 12px;
    }
    h2 { text-align: center; color: #333; font-size: 22px; margin-bottom: 15px; }
    label { display: block; margin: 8px 0 4px; color: #555; font-size: 14px; }
    input {
      width: 100%;
      min-width: 0;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 14px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 8px;
    }
    button:hover { background: #45a049; }
    .result {
      width: 100%;
      margin-top: 18px;
      padding: 15px;
      background: #f0f9ff;
      border: 1px solid #b6e0fe;
      border-radius: 10px;
      color: #333;
      font-size: 15px;
      line-height: 1.6;
    }
	
	 /* 卡片收合動畫 */
    #multiplierCard {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.3s ease;
      background: #fff;
      border-radius: 12px;
      margin-top: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 0 15px;
    }
    #multiplierCard.show {
      max-height: 10000px; /* 足夠展開 */
      padding: 15px;
    }
	
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 10px; }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
      word-wrap: break-word;
    }
    th { background: #f2f2f2; }
    @media (max-width: 480px) {
      h2 { font-size: 20px; }
      .result { font-size: 14px; }
      button { font-size: 16px; padding: 14px; }
      input { font-size: 16px; padding: 12px; }
    }
	
	
	.arrow {
  display: inline-block;
  transition: transform 0.3s ease;
}
.arrow.rotate {
  transform: rotate(180deg);
}


  </style>
</head>
<body>
  <h2>小推車運算程式</h2>

  <!-- 天數計算 -->
  <div class="card">
    <h3 style="text-align:center;">依天數計算小推車產量</h3>


	
	
	
	
<h3>選擇來源</h3>

  <label><input type="radio" name="option" value="S1" onchange="setDays();calculateResult()"> S1: 持續至 2025/08/30</label><br>
  <label><input type="radio" name="option" value="S2" onchange="setDays();calculateResult()"> S2: 持續至 2025/11/05</label><br>
  <label><input type="radio" name="option" value="manual" onchange="setDays();calculateResult()"> S3: 手動輸入</label><br><br>

    <!-- 每小時產出 -->
	<label for="days">輸入剩餘天數：</label>
    <input type="number" id="days" value="" oninput="handleDaysInput();calculateResult();calculateResult1()">

	<p id="today">今天日期：</p>
	<p id="day_status">剩餘天數：0</p>
  
	
	  <!-- 收合按鈕 -->
  <button type="button" id="toggleBtn" onclick="toggleMultiplier()">
    <span id="arrow" class="arrow">▼</span>
    <span id="btnText">展開小推車設定</span>
  </button>
  
	<div class="card" id="multiplierCard">
    
      <div class="table-container">
        <table>
          <tr>
            <th>資源</th>
            <th>每小時產出</th>
          </tr>
          <tr><td>金幣</td><td><input type="number" id="hour_gold" oninput="handleDaysInput()"></td></tr>          
          <tr><td>粗煉石</td><td><input type="number" id="hour_stone" oninput="handleDaysInput()"></td></tr>
          <tr><td>精華</td><td><input type="number" id="hour_essence" oninput="handleDaysInput()"></td></tr>
		  <tr><td>砂</td><td><input type="number" id="hour_sand" oninput="handleDaysInput()"></td></tr>
          <tr><td>飼料</td><td><input type="number" id="hour_feed" oninput="handleDaysInput()"></td></tr>
        </table>
      </div>
    

  

    <!-- 小推車總產量 -->
    <div class="table-container">
      <table>
        <thead>
          <tr><th>資源</th><th style="color:purple;">總產量</th></tr>
        </thead>
        <tbody id="day_result"></tbody>
      </table>
    </div>

    <!-- 差額數量 -->
    <h3>差額數量:</h3>
    <label>
      <span style="color:green;">期望值</span> - 
      <span style="color:purple;">總產量</span> - 
      <span style="color:orange;">目前有的</span>
    </label>
    
    <!-- 目標資源 -->
    <div class="card">
      <div class="table-container">
        <table>
          <tr><th>資源</th><th style="color:green;">期望值</th></tr>
          <tr><td>金幣</td><td><input type="number" id="target_gold" oninput="handleDaysInput()"></td></tr>          
          <tr><td>粗煉石</td><td><input type="number" id="target_stone" oninput="handleDaysInput()"></td></tr>
          <tr><td>精華</td><td><input type="number" id="target_essence" oninput="handleDaysInput()"></td></tr>
		  <tr><td>砂</td><td><input type="number" id="target_sand" oninput="handleDaysInput()"></td></tr>
          <tr><td>飼料</td><td><input type="number" id="target_feed" oninput="handleDaysInput()"></td></tr>
        </table>
      </div>
    </div>

    <!-- 目前資源 -->
    <div class="card">
      <div class="table-container">
        <table>
          <tr><th>資源</th><th style="color:orange;">目前有的</th></tr>
          <tr><td>金幣</td><td><input type="number" id="current_gold" oninput="handleDaysInput()"></td></tr>          
          <tr><td>粗煉石</td><td><input type="number" id="current_stone" oninput="handleDaysInput()"></td></tr>
          <tr><td>精華</td><td><input type="number" id="current_essence" oninput="handleDaysInput()"></td></tr>
		  <tr><td>砂</td><td><input type="number" id="current_sand" oninput="handleDaysInput()"></td></tr>
          <tr><td>飼料</td><td><input type="number" id="current_feed" oninput="handleDaysInput()"></td></tr>
        </table>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr><th>資源</th><th>差額數量(<span style="color:red">負數代表溢出</span>)</th></tr>
        </thead>
        <tbody id="day_result1"></tbody>
      </table>
    </div>

    <!-- 秘境差額需要次數 -->
    <h3>秘境差額需要次數:</h3>
    <label>差額數量 / 秘境單次挖出數量預測</label>
    <div class="card">
      <div class="table-container">
        <table>
          <tr><th>資源</th><th>秘境單次挖出數量預測</th></tr>
          <tr><td>金幣</td><td><input type="number" id="current1_gold" oninput="handleDaysInput()"></td></tr>          
          <tr><td>粗煉石</td><td><input type="number" id="current1_stone" oninput="handleDaysInput()"></td></tr>
          <tr><td>精華</td><td><input type="number" id="current1_essence" oninput="handleDaysInput()"></td></tr>
		  <tr><td>砂</td><td><input type="number" id="current1_sand" oninput="handleDaysInput()"></td></tr>
        </table>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr><th>材料</th><th>秘境需要次數</th></tr>
        </thead>
        <tbody id="day_result2"></tbody>
      </table>
    </div>
	</div>
    
    <label for="times">輸入每日購買次數：( 購買次數 x 5 ) x 天數</label>
    <input type="number" id="times" value="" oninput="calculateResult()">
    <br>
    <p id="total_result">總挖掘：</p>
  </div>

  <!-- 計算按鈕 -->
  <div style="text-align:center;">
    <button onclick="calculate()">計算資源達成時間</button>
    <button onclick="clearAll()" style="background:#f44336;">重新計算</button>
    <button onclick="saveData()" style="background:#2196F3;">💾 儲存數據</button>
    <button onclick="resetData()" style="background:#FF9800;">♻️ 恢復預設</button>
    <button onclick="window.location.href='https://pure08402-dev.github.io/test7/'">返回首頁</button>
  </div>

  <!-- 結果 -->
  <div class="result" id="result">請輸入資料並按下計算</div>

<script>
let countdownTimer; // 🔹 全域變數：倒數計時器

function calculate() {
  const resources = [
    { name: "金幣", target: "target_gold", current: "current_gold", hour: "hour_gold" },
    { name: "粗煉石", target: "target_stone", current: "current_stone", hour: "hour_stone" },
    { name: "精華", target: "target_essence", current: "current_essence", hour: "hour_essence" },
    { name: "砂", target: "target_sand", current: "current_sand", hour: "hour_sand" },
    { name: "飼料", target: "target_feed", current: "current_feed", hour: "hour_feed" }
  ];
  
  let output = "<h3>小推車達成時間</h3><div class='table-container'><table><tr><th>資源</th><th>還需要</th><th>小時數</th><th>天數</th></tr>";
  
  resources.forEach(r => {
    const target = parseInt(document.getElementById(r.target).value) || 0;
    const current = parseInt(document.getElementById(r.current).value) || 0;
    const perHour = parseInt(document.getElementById(r.hour).value) || 0;

    const need = Math.max(target - current, 0);
    const hours = perHour > 0 ? (need / perHour).toFixed(2) : "∞";
    const days = perHour > 0 ? (hours / 24).toFixed(2) : "∞";
    
    output += `<tr>
      <td>${r.name}</td>
      <td>${need.toLocaleString()}</td>
      <td>${hours}</td>
      <td>${days} 天</td>
    </tr>`;
  });

  output += "</table></div>";
  document.getElementById("result").innerHTML = output;
}

function clearAll() {
  document.querySelectorAll("input").forEach(input => {
    if (input.type === "radio") {
      input.checked = false;
    } else {
      input.value = "";
    }
  });
  document.getElementById("days").disabled = true;
  document.getElementById("result").innerHTML = "請輸入資料並按下計算";
  document.getElementById("day_result").innerHTML = "";
  document.getElementById("day_result1").innerHTML = "";
  document.getElementById("day_result2").innerHTML = "";
  document.getElementById("total_result").textContent = "總挖掘：";
  document.getElementById("day_status").textContent = "剩餘天數：0";
  clearInterval(countdownTimer);
}

const baseValues = {
  "金幣": "hour_gold",
  "粗煉石": "hour_stone",
  "精華": "hour_essence",
  "砂": "hour_sand",
  "飼料": "hour_feed"
};

function handleDaysInput() {
  const days = parseInt(document.getElementById("days").value) || 0;
  let htmlTotal = "", htmlDiff = "", htmlTimes = "";

  function formatNumberWithWan(num) {
    const n = parseInt(num) || 0;
    const wan = (n / 10000).toFixed(2);
    return `${wan}萬 (${n.toLocaleString()})`;
  }

  for (let item in baseValues) {
    const perHour = parseInt(document.getElementById(baseValues[item]).value) || 0;
    const current = parseInt(document.getElementById("current_" + baseValues[item].split("_")[1]).value) || 0;
    const target = parseInt(document.getElementById("target_" + baseValues[item].split("_")[1]).value) || 0;

    const total = perHour * 24 * days;
    const diff = target - total - current;
    const diffDisplay = diff < 0 ? `<span style="color:red">${formatNumberWithWan(diff)}</span>` : formatNumberWithWan(diff);

    htmlTotal += `<tr><td>${item}</td><td>${formatNumberWithWan(total)}</td></tr>`;
    htmlDiff  += `<tr><td>${item}</td><td>${diffDisplay}</td></tr>`;

    if (item !== "飼料") {
      const dungeon = parseInt(document.getElementById("current1_" + baseValues[item].split("_")[1]).value) || 0;
      const times = dungeon > 0 ? Math.ceil(Math.max(diff, 0) / dungeon) : "∞";
      htmlTimes += `<tr><td>${item}</td><td>${times}</td></tr>`;
    }
  }

  document.getElementById("day_result").innerHTML = htmlTotal;
  document.getElementById("day_result1").innerHTML = htmlDiff;
  document.getElementById("day_result2").innerHTML = htmlTimes;
}

function calculateResult() {
  const days = parseInt(document.getElementById("days").value) || 0;
  const times = parseInt(document.getElementById("times").value) || 0;
  const result = days * 5 * times;
  document.getElementById("total_result").textContent = "總挖掘：" + result + " 次";
}

// 🔹 展開設定卡片
function toggleMultiplier() {
  const card = document.getElementById("multiplierCard");
  const btnText = document.getElementById("btnText");
  const arrow = document.getElementById("arrow");
  card.classList.toggle("show");
  arrow.classList.toggle("rotate");
  btnText.textContent = card.classList.contains("show") ? "收起小推車設定" : "展開小推車設定";
}

// 🔹 儲存資料
function saveData() {
  let inputs = {};
  document.querySelectorAll("input").forEach(input => {
    inputs[input.id] = input.value;
  });
  localStorage.setItem("cartData", JSON.stringify(inputs));
  alert("✅ 資料已儲存！");
}

// 🔹 載入資料
function loadData() {
  const saved = localStorage.getItem("cartData");
  if (saved) {
    const inputs = JSON.parse(saved);
    Object.keys(inputs).forEach(id => {
      if (document.getElementById(id)) {
        document.getElementById(id).value = inputs[id];
      }
    });
  }
  handleDaysInput();
  calculateResult();
}

// 🔹 恢復預設
function resetData() {
  localStorage.removeItem("cartData");
  clearAll();
  alert("♻️ 已恢復預設，並清除儲存的資料！");
}

// 🔹 顯示今天日期
function showToday() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, "0");
  const day = String(today.getDate()).padStart(2, "0");
  document.getElementById("today").textContent = `今天日期：${year}/${month}/${day}`;
}

// ✅ 改良版：以早上 8 點為基準 + 即時倒數
function setDays() {
  const selected = document.querySelector("input[name='option']:checked").value;
  const daysInput = document.getElementById("days");
  clearInterval(countdownTimer);

  if (selected === "manual") {
    daysInput.value = "";
    daysInput.disabled = false;
    document.getElementById("day_status").innerHTML = "目前天數：0（手動輸入模式）";
  } else {
    let endDate, labelText;
    if (selected === "S1") {
      endDate = new Date("2025-08-30T08:00:00");
      labelText = "2025/08/30";
    } else if (selected === "S2") {
      endDate = new Date("2025-11-05T08:00:00");
      labelText = "2025/11/05";
    }

    const now = new Date();
    const diffTime = endDate.getTime() - now.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const daysRemaining = diffDays > 0 ? diffDays : 0;

    daysInput.value = daysRemaining;
    daysInput.disabled = true;

    document.getElementById("day_status").innerHTML = `
      剩餘天數：<strong>${daysRemaining}</strong> 天
      <br><span style="font-size:13px;color:#555;">（截止至 ${labelText} 早上 08:00）</span>
      <br><span id="countdown" style="color:#2b7cff;font-weight:bold;"></span>
    `;
    startCountdown(endDate);
  }
  calculateResult1();
}

// ✅ 動態倒數
function startCountdown(endDate) {
  function updateCountdown() {
    const now = new Date();
    const distance = endDate - now;
    if (distance <= 0) {
      clearInterval(countdownTimer);
      document.getElementById("countdown").textContent = "⏰ 倒數結束！";
      return;
    }
    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    document.getElementById("countdown").textContent = 
      `⏳ 還有 ${days}天 ${hours}小時 ${minutes}分 ${seconds}秒`;
  }
  updateCountdown();
  countdownTimer = setInterval(updateCountdown, 1000);
}

function calculateResult1() {
  const days = parseInt(document.getElementById("days").value) || 0;
  if (!document.getElementById("countdown")) {
    document.getElementById("day_status").textContent = "剩餘天數：" + days;
  }
}

// 頁面載入
window.onload = () => {
  showToday();
  loadData();
};
</script>

</body>
</html>
