<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¶“é©—æ™‚é–“è¨ˆç®—å™¨</title>
<style>
:root {
  --main-bg: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  --card-bg: rgba(255, 255, 255, 0.8);
  --accent: #2563eb;
  --accent-light: #3b82f6;
  --text-dark: #1e3a8a;
  --text-sub: #475569;
  --input-bg: rgba(255,255,255,0.9);
}

/* å¤œé–“æ¨¡å¼ */
body.dark {
  --main-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --card-bg: rgba(30, 41, 59, 0.85);
  --accent: #60a5fa;
  --accent-light: #93c5fd;
  --text-dark: #e2e8f0;
  --text-sub: #94a3b8;
  --input-bg: rgba(51,65,85,0.8);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
  background: var(--main-bg);
  color: var(--text-dark);
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  transition: background 0.4s, color 0.3s;
}

main.card {
  backdrop-filter: blur(14px) saturate(160%);
  background: var(--card-bg);
  border-radius: 20px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.2);
  margin: 16px;
  padding: 24px 18px 28px 18px;
  max-width: 480px;
  width: calc(100% - 32px);
}

h2 {
  text-align: center;
  font-size: 1.6em;
  color: var(--accent);
}
small {
  display: block;
  text-align: center;
  color: var(--text-sub);
  margin-bottom: 10px;
}
form { display: flex; flex-direction: column; gap: 14px; }
label { font-weight: 600; }
input, select {
  width: 100%; box-sizing: border-box;
  padding: 10px 12px;
  border: 1px solid #93c5fd;
  border-radius: 10px;
  font-size: 1em;
  background: var(--input-bg);
  color: var(--text-dark);
}
input:focus, select:focus {
  outline: none; border-color: var(--accent);
  box-shadow: 0 0 5px rgba(59,130,246,0.5);
}
button {
  padding: 14px; border: none; border-radius: 12px;
  background: var(--accent-light); color: #fff;
  font-size: 1.1em; font-weight: bold; cursor: pointer;
  transition: all 0.3s;
}
button:hover { background: var(--accent); transform: translateY(-1px); }
.results {
  margin-top: 22px; padding: 16px 14px; border-radius: 14px;
  background: rgba(255,255,255,0.6);
  box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
}
body.dark .results { background: rgba(51,65,85,0.8); }

.theme-toggle {
  position: fixed; right: 16px; bottom: 16px;
  background: var(--accent-light); color: #fff;
  border: none; border-radius: 50%; width: 52px; height: 52px;
  font-size: 1.6em; cursor: pointer; z-index: 9999;
  display: flex; justify-content: center; align-items: center;
}

/* è™›æ“¬éµç›¤æ¨£å¼ */
.virtual-keypad {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--card-bg);
  border: 2px solid var(--accent-light);
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  padding: 15px;
  z-index: 9999;
  width: 250px;
  text-align: center;
}
.virtual-keypad-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.virtual-keypad-header span {
  font-weight: bold;
  color: var(--accent);
  font-size: 1.1em;
}
.virtual-keypad-header button {
  background: transparent;
  border: none;
  font-size: 1.2em;
  color: #ef4444;
  cursor: pointer;
}
.virtual-keypad button {
  width: 60px;
  height: 50px;
  margin: 4px;
  font-size: 1.2em;
  border: none;
  border-radius: 10px;
  background: var(--accent-light);
  color: white;
  cursor: pointer;
  transition: 0.2s;
}
.virtual-keypad button:hover {
  background: var(--accent);
}
</style>
</head>

<body>

<main class="card">
  <h2>ç¶“é©—æ™‚é–“è¨ˆç®—å™¨</h2>
    <small>ç°¡å–®è¨ˆç®—,åƒ…åŠŸåƒè€ƒ</small>
	<small>å¯¦éš›ä»¥éŠæˆ²ç‚ºä¸»</small>

  <form id="expForm">
    <label>é¸æ“‡è³½å­£</label>
    <select id="seasonSelect">
      <option value="s1">S1-æ¾¤ä¹‹åœ‹</option>
      <option value="s2">S2-é¾ä¹‹åœ‹</option>
      <option value="s3" selected>S3-ç¾½ä¹‹åœ‹</option>
    </select>

    <label>ç¾åœ¨ç­‰ç´šï¼ˆLvï¼‰</label>
    <input id="currentLevel" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š98">

    <label>ç¾æœ‰ç¶“é©—ï¼ˆExpï¼Œè¬ï¼‰<span class="unit-label">è¼¸å…¥ 5 ä»£è¡¨ 50000</span></label>
    <input id="currentExp" type="number" inputmode="numeric" pattern="[0-9]*" step="0.1" placeholder="ä¾‹å¦‚ï¼š5">

    <label>ç›®æ¨™ç­‰ç´šï¼ˆLvï¼‰</label>
    <input id="targetLevel" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š100">

    <label>æ¯å°æ™‚ç¶“é©—ï¼ˆEXP/hï¼‰</label>
    <input id="expPerHour" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š20000">

    <div class="divider">åŠ é€Ÿé …ç›®</div>
    <div class="flex-row">
      <div class="flex-col">
        <label>æ—¥å¸¸åŠ é€Ÿæ¬¡æ•¸</label>
        <input id="dailyBoosts" type="number" min="0" value="0">
      </div>
      <div class="flex-col">
        <label>çŸ³é ­åŠ é€Ÿæ¬¡æ•¸</label>
        <input id="stoneBoosts" type="number" min="0" value="0">
      </div>
    </div>

    <button type="submit" disabled>âœ¨ æ­£åœ¨è¼‰å…¥ç¶“é©—è¡¨â€¦ âœ¨</button>
  </form>

  <section id="results" class="results" hidden>
    <p id="remainingExp"></p>
    <p id="neededSeconds"></p>
    <p id="nowTime"></p>
    <p id="finishTime"></p>
    <p id="acceleratedTime"></p>
    <p id="countdown"></p>
    <p id="acceleratedCountdown"></p>
  </section>

  <footer>ç¾½ä¹‹åœ‹ Ver 1.2.0</footer>
</main>

<!-- å¤œé–“æ¨¡å¼åˆ‡æ› -->
<button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

<!-- è™›æ“¬æ•¸å­—éµç›¤ -->
<div class="virtual-keypad" id="keypad">
  <div class="virtual-keypad-header">
    <span>æ•¸å­—éµç›¤</span>
    <button id="closeKeypad">âŒ</button>
  </div>
  <div id="keypadButtons"></div>
</div>

<script>
// === å¤œé–“æ¨¡å¼ ===
const body = document.body;
const themeToggle = document.getElementById("themeToggle");
function applyTheme(dark) {
  body.classList.toggle("dark", dark);
  themeToggle.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
  localStorage.setItem("theme", dark ? "dark" : "light");
}
applyTheme(localStorage.getItem("theme") === "dark");
themeToggle.addEventListener("click", () => applyTheme(!body.classList.contains("dark")));

// === ç¶“é©—è¡¨ ===
let EXP_TABLE = new Map(), prefixSum = [];
function updatePrefixSum(){
  const lv = [...EXP_TABLE.keys()];
  const max = Math.max(...lv);
  prefixSum = [0];
  for(let i=1;i<=max;i++) prefixSum[i]=prefixSum[i-1]+(EXP_TABLE.get(i)||0);
}
const submitBtn = document.querySelector("#expForm button[type='submit']");
const seasonSelect = document.getElementById("seasonSelect");
function loadExpTable(season){
  submitBtn.disabled=true;
  submitBtn.textContent="âœ¨ æ­£åœ¨è¼‰å…¥ç¶“é©—è¡¨â€¦ âœ¨";
  EXP_TABLE.clear();
  fetch(`static/database/exp_${season}.csv`)
  .then(r=>r.text())
  .then(t=>{
    t.trim().split(/\r?\n/).slice(1).forEach(line=>{
      const [lv,exp]=line.split(',').map(Number);
      if(!isNaN(lv)&&!isNaN(exp))EXP_TABLE.set(lv,exp);
    });
    updatePrefixSum();
    submitBtn.disabled=false;
    submitBtn.textContent="âœ¨ é–‹å§‹è¨ˆç®— âœ¨";
  })
  .catch(()=>{submitBtn.textContent="âš  è®€å–å¤±æ•—ï¼Œè«‹åˆ·æ–°";});
}
loadExpTable(seasonSelect.value);
seasonSelect.addEventListener("change",e=>loadExpTable(e.target.value));

const fmtNum=n=>new Intl.NumberFormat().format(n);
const fmtDur=s=>{
  if(s<=0)return"0ç§’";
  const d=Math.floor(s/86400);s%=86400;
  const h=Math.floor(s/3600);s%=3600;
  const m=Math.floor(s/60);s%=60;
  return`${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
};
const remainExp=(c,e,t)=>prefixSum[t]-prefixSum[c]-e;

// å€’æ•¸
let timer=0;
function startCountdown(finishAt,accFinishAt){
  const cd=document.getElementById("countdown");
  const acc=document.getElementById("acceleratedCountdown");
  clearInterval(timer);
  timer=setInterval(()=>{
    const now=Date.now();
    const r=Math.max(0,Math.floor((finishAt-now)/1000));
    const a=Math.max(0,Math.floor((accFinishAt-now)/1000));
    cd.textContent=r<=0?"å€’è¨ˆæ™‚ï¼šå·²å®Œæˆï¼":`å€’è¨ˆæ™‚ï¼š${fmtDur(r)}`;
    acc.textContent=a<=0?"åŠ é€Ÿå€’è¨ˆæ™‚ï¼šå·²å®Œæˆï¼":`åŠ é€Ÿå€’è¨ˆæ™‚ï¼š${fmtDur(a)}`;
    if(r<=0 && a<=0) clearInterval(timer);
  },1000);
}

// ä¸»é‚è¼¯
document.getElementById("expForm").addEventListener("submit", e=>{
  e.preventDefault();
  if(EXP_TABLE.size===0){alert("ç¶“é©—è¡¨å°šæœªè¼‰å…¥å®Œæˆï¼");return;}
  const c=+currentLevel.value||0;
  const ce=(+currentExp.value||0)*10000;
  const t=+targetLevel.value||0;
  const eph=+expPerHour.value||0;
  const boosts=(+dailyBoosts.value||0)+(+stoneBoosts.value||0);
  if(c<=0||t<=c||eph<=0){alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ç­‰ç´šèˆ‡ç¶“é©—å€¼");return;}
  const remain=remainExp(c,ce,t);
  if(!isFinite(remain)||remain<=0){alert("å·²é”ç›®æ¨™ç­‰ç´šæˆ–ç¶“é©—ä¸è¶³ã€‚");return;}
  const secs=remain/(eph/3600);
  const now=Date.now();
  const finishAt=now+secs*1000;
  const accFinishAt=finishAt-boosts*7200*1000;
  const res=document.getElementById("results");
  res.hidden=false;
  remainingExp.textContent=`å‰©é¤˜ç¶“é©—ï¼š${fmtNum(remain)}`;
  neededSeconds.textContent=`é è¨ˆè€—æ™‚ï¼š${fmtDur(Math.floor(secs))}`;
  nowTime.textContent=`ç¾åœ¨æ™‚é–“ï¼š${new Date(now).toLocaleString()}`;
  finishTime.textContent=`å®Œæˆæ™‚é–“ï¼š${new Date(finishAt).toLocaleString()}`;
  acceleratedTime.textContent=`åŠ é€Ÿå®Œæˆï¼š${new Date(accFinishAt).toLocaleString()}`;
  startCountdown(finishAt,accFinishAt);
});

// === è™›æ“¬æ•¸å­—éµç›¤ ===
const keypad=document.getElementById("keypad");
const btnArea=document.getElementById("keypadButtons");
["1","2","3","4","5","6","7","8","9","0",".","âŒ«"].forEach(k=>{
  const btn=document.createElement("button");
  btn.textContent=k;
  btn.addEventListener("click",()=>{
    if(!keypad.target)return;
    if(k==="âŒ«")keypad.target.value=keypad.target.value.slice(0,-1);
    else keypad.target.value+=k;
  });
  btnArea.appendChild(btn);
});
document.querySelectorAll('input[type="number"]').forEach(inp=>{
  inp.addEventListener('focus',e=>{
    keypad.style.display="block";
    keypad.target=e.target;
  });
  inp.addEventListener('click',e=>keypad.target=e.target);
});
document.getElementById("closeKeypad").addEventListener("click",()=>{
  keypad.style.display="none";
  keypad.target=null;
});
</script>
</body>
</html>
