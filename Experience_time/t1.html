<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¾½ä¹‹åœ‹ S3 ç¶“é©—æ™‚é–“è¨ˆç®—å™¨</title>
<style>
:root {
  --main-bg: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  --card-bg: rgba(255, 255, 255, 0.8);
  --accent: #2563eb;
  --accent-light: #3b82f6;
  --text-dark: #1e3a8a;
  --text-sub: #475569;
  --input-bg: rgba(255,255,255,0.9);
}
body.dark {
  --main-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --card-bg: rgba(30, 41, 59, 0.85);
  --accent: #60a5fa;
  --accent-light: #93c5fd;
  --text-dark: #e2e8f0;
  --text-sub: #94a3b8;
  --input-bg: rgba(51,65,85,0.8);
}
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: var(--main-bg);
  color: var(--text-dark);
  min-height: 100vh;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  transition: background 0.4s ease, color 0.3s ease;
}
main.card {
  backdrop-filter: blur(14px) saturate(160%);
  background: var(--card-bg);
  border-radius: 20px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.2);
  margin: 16px;
  padding: 22px 18px 26px 18px;
  max-width: 480px;
  width: calc(100% - 32px);
  box-sizing: border-box;
  position: relative;
  animation: fadeIn 0.8s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
h2 {
  text-align: center;
  font-size: 1.6em;
  color: var(--accent);
  margin-bottom: 6px;
}
small {
  display: block;
  text-align: center;
  color: var(--text-sub);
  margin-bottom: 14px;
}
form {
  display: flex;
  flex-direction: column;
  gap: 14px;
}
label {
  font-weight: bold;
  font-size: 0.95em;
  margin-bottom: 4px;
  display: block;
}
input {
  width: 100%;
  box-sizing: border-box;
  padding: 10px 12px;
  border: 1px solid #93c5fd;
  border-radius: 10px;
  font-size: 1em;
  background: var(--input-bg);
  color: var(--text-dark);
  transition: 0.2s;
}
input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 5px rgba(59,130,246,0.5);
}
button {
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: var(--accent-light);
  color: #fff;
  font-size: 1.1em;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  width: 100%;
}
button:hover {
  background: var(--accent);
  transform: translateY(-1px);
}
.results {
  margin-top: 22px;
  padding: 16px 14px;
  border-radius: 14px;
  background: rgba(255,255,255,0.6);
  box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
  line-height: 1.7;
  animation: fadeIn 0.5s ease;
  word-wrap: break-word;
}
body.dark .results {
  background: rgba(51,65,85,0.8);
}
#countdown, #acceleratedCountdown {
  font-weight: bold;
  color: var(--accent);
}
footer {
  text-align: center;
  margin-top: 22px;
  font-size: 0.85em;
  color: var(--text-sub);
}
.unit-label {
  font-size: 0.85em;
  color: #64748b;
  margin-left: 6px;
}
body.dark .unit-label { color: #cbd5e1; }
.divider {
  text-align: center;
  margin: 14px 0;
  color: #93c5fd;
  font-weight: bold;
}
.flex-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.flex-col {
  flex: 1 1 45%;
}
@media (max-width:600px){
  main.card{margin:10px;padding:18px;}
  h2{font-size:1.3em;}
  button{font-size:1em;padding:12px;}
  input{font-size:0.95em;}
}

/* æµ®å‹•å¤œé–“æ¨¡å¼æŒ‰éˆ• */
.theme-toggle {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background: var(--accent-light);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  font-size: 1.5em;
  cursor: pointer;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform 0.3s, background 0.3s;
  z-index: 9999;
}
.theme-toggle:hover {
  transform: scale(1.2);
  background: var(--accent);
}
</style>
</head>
<body>

<main class="card">
  <h2>ç¶“é©—æ™‚é–“è¨ˆç®—å™¨</h2>
  <small>ç°¡å–®è¨ˆç®—,åƒ…åŠŸåƒè€ƒ</small>
  <small>å¯¦éš›ä»¥éŠæˆ²ç‚ºä¸»</small>

  <form id="expForm">
    <label>é¸æ“‡è³½å­£</label>
    <select id="seasonSelect">
      <option value="s1">S1-æ¾¤ä¹‹åœ‹</option>
      <option value="s2">S2-é¾ä¹‹åœ‹</option>
      <option value="s3" selected>S3-ç¾½ä¹‹åœ‹</option>
    </select>

    <label>ç¾åœ¨ç­‰ç´šï¼ˆLvï¼‰</label>
    <input id="currentLevel" type="number" min="1" placeholder="ä¾‹å¦‚ï¼š98">

    <label>ç¾æœ‰ç¶“é©—ï¼ˆExpï¼Œè¬ï¼‰<span class="unit-label">è¼¸å…¥ 5 ä»£è¡¨ 50000</span></label>
    <input id="currentExp" type="number" min="0" step="0.1" placeholder="ä¾‹å¦‚ï¼š5">

    <label>ç›®æ¨™ç­‰ç´šï¼ˆLvï¼‰</label>
    <input id="targetLevel" type="number" min="1" placeholder="ä¾‹å¦‚ï¼š100">

    <label>æ¯å°æ™‚ç¶“é©—ï¼ˆEXP/hï¼‰</label>
    <input id="expPerHour" type="number" min="1" placeholder="ä¾‹å¦‚ï¼š20000">

    <div class="divider">åŠ é€Ÿé …ç›®</div>
    <div class="flex-row">
      <div class="flex-col">
        <label>æ—¥å¸¸åŠ é€Ÿæ¬¡æ•¸</label>
        <input id="dailyBoosts" type="number" min="0" value="0">
      </div>
      <div class="flex-col">
        <label>çŸ³é ­åŠ é€Ÿæ¬¡æ•¸</label>
        <input id="stoneBoosts" type="number" min="0" value="0">
      </div>
    </div>

    <button type="submit" disabled>âœ¨ æ­£åœ¨è¼‰å…¥ç¶“é©—è¡¨â€¦ âœ¨</button>
  </form>

  <section id="results" class="results" hidden>
    <p id="remainingExp"></p>
    <p id="neededSeconds"></p>
    <p id="nowTime"></p>
    <p id="finishTime"></p>
    <p id="acceleratedTime"></p>
    <p id="countdown"></p>
    <p id="acceleratedCountdown"></p>
  </section>

  <footer>Â© å°å’•ãƒ»ç¾½ä¹‹åœ‹ Ver 1.2.0</footer>
</main>

<!-- æµ®å‹•å¤œé–“åˆ‡æ›æŒ‰éˆ• -->
<button class="theme-toggle" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ™</button>

<script>
// ====== å¤œé–“æ¨¡å¼åˆ‡æ› ======
const body = document.body;
const themeToggle = document.getElementById("themeToggle");
function applyTheme(dark) {
  body.classList.toggle("dark", dark);
  themeToggle.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
  localStorage.setItem("theme", dark ? "dark" : "light");
}
applyTheme(localStorage.getItem("theme") === "dark");
themeToggle.addEventListener("click", () => applyTheme(!body.classList.contains("dark")));

// ====== ç¶“é©—è¡¨è‡ªå‹•è®€å– ======
let EXP_TABLE = new Map();
let prefixSum = [];

function updatePrefixSum() {
  const levels = [...EXP_TABLE.keys()];
  const maxLv = Math.max(...levels);
  prefixSum = [0];
  for (let i = 1; i <= maxLv; i++) {
    prefixSum[i] = prefixSum[i-1] + (EXP_TABLE.get(i) || 0);
  }
}

const submitBtn = document.querySelector("#expForm button[type='submit']");
const seasonSelect = document.getElementById("seasonSelect");

function loadExpTable(season) {
  submitBtn.disabled = true;
  submitBtn.textContent = "âœ¨ æ­£åœ¨è¼‰å…¥ç¶“é©—è¡¨â€¦ âœ¨";
  EXP_TABLE.clear();
  fetch(`static/database/exp_${season}.csv`)
    .then(res => res.text())
    .then(text => {
      text.trim().split(/\r?\n/).slice(1).forEach(line => {
        const [lv, exp] = line.split(',').map(Number);
        if (!isNaN(lv) && !isNaN(exp)) EXP_TABLE.set(lv, exp);
      });
      updatePrefixSum();
      console.log(`ç¶“é©—è¡¨ ${season.toUpperCase()} å·²è¼‰å…¥å®Œæˆï¼`);
      submitBtn.disabled = false;
      submitBtn.textContent = "âœ¨ é–‹å§‹è¨ˆç®— âœ¨";
    })
    .catch(err => {
      console.error('è®€å– CSV å¤±æ•—', err);
      submitBtn.textContent = "âš  è®€å–å¤±æ•—ï¼Œè«‹åˆ·æ–°";
    });
}

// åˆå§‹è¼‰å…¥
loadExpTable(seasonSelect.value);

// æ”¹è®Šè³½å­£æ™‚é‡æ–°è¼‰å…¥
seasonSelect.addEventListener("change", e => loadExpTable(e.target.value));

// ====== å·¥å…·å‡½æ•¸ ======
const fmtNum = n => new Intl.NumberFormat().format(n);
const fmtDur = s => {
  if (s <= 0) return "0ç§’";
  const d = Math.floor(s/86400); s %= 86400;
  const h = Math.floor(s/3600); s %= 3600;
  const m = Math.floor(s/60); s %= 60;
  return `${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
};
const remainExp = (curLv, curExp, tgtLv) => prefixSum[tgtLv]-prefixSum[curLv]-curExp;

// ====== å€’æ•¸è¨ˆæ™‚ ======
let timer = 0;
function startCountdown(finishAt, accFinishAt){
  const cd=document.getElementById("countdown");
  const acc=document.getElementById("acceleratedCountdown");
  clearInterval(timer);
  timer=setInterval(()=>{
    const now=Date.now();
    const r=Math.max(0,Math.floor((finishAt-now)/1000));
    const a=Math.max(0,Math.floor((accFinishAt-now)/1000));
    cd.textContent=r<=0?"å€’è¨ˆæ™‚ï¼šå·²å®Œæˆï¼":`å€’è¨ˆæ™‚ï¼š${fmtDur(r)}`;
    acc.textContent=a<=0?"åŠ é€Ÿå€’è¨ˆæ™‚ï¼šå·²å®Œæˆï¼":`åŠ é€Ÿå€’è¨ˆæ™‚ï¼š${fmtDur(a)}`;
    if(r<=0 && a<=0) clearInterval(timer);
  },1000);
}

// ====== ä¸»é‚è¼¯ ======
document.getElementById("expForm").addEventListener("submit", e=>{
  e.preventDefault();
  if (EXP_TABLE.size === 0) { alert("ç¶“é©—è¡¨å°šæœªè¼‰å…¥å®Œæˆï¼"); return; }

  const curLv=+document.getElementById("currentLevel").value||0;
  const curExp=(+document.getElementById("currentExp").value||0)*10000;
  const tgtLv=+document.getElementById("targetLevel").value||0;
  const eph=+document.getElementById("expPerHour").value||0;
  const boosts=(+document.getElementById("dailyBoosts").value||0)+(+document.getElementById("stoneBoosts").value||0);

  if(curLv<=0 || tgtLv<=curLv || eph<=0){ alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ç­‰ç´šèˆ‡ç¶“é©—å€¼"); return; }

  const remain = remainExp(curLv, curExp, tgtLv);
  if(!isFinite(remain) || remain<=0){ alert("å·²é”ç›®æ¨™ç­‰ç´šæˆ–ç¶“é©—ä¸è¶³ã€‚"); return; }

  const secs = remain/(eph/3600);
  const now = Date.now();
  const finishAt = now + secs*1000;
  const accFinishAt = finishAt - boosts*7200*1000;

  const res = document.getElementById("results");
  res.hidden = false;
  document.getElementById("remainingExp").textContent = `å‰©é¤˜ç¶“é©—ï¼š${fmtNum(remain)}`;
  document.getElementById("neededSeconds").textContent = `é è¨ˆè€—æ™‚ï¼š${fmtDur(Math.floor(secs))}`;
  document.getElementById("nowTime").textContent = `ç¾åœ¨æ™‚é–“ï¼š${new Date(now).toLocaleString()}`;
  document.getElementById("finishTime").textContent = `å®Œæˆæ™‚é–“ï¼š${new Date(finishAt).toLocaleString()}`;
  document.getElementById("acceleratedTime").textContent = `åŠ é€Ÿå®Œæˆï¼š${new Date(accFinishAt).toLocaleString()}`;
  startCountdown(finishAt, accFinishAt);
});

// ====== é¸æ“‡è³½å­£è‡ªå‹•ä¿å­˜åˆ° localStorage ======
const seasonSelect = document.getElementById("seasonSelect");

// åˆå§‹å€¼å¾ localStorage æˆ–é è¨­ S3
const savedSeason = localStorage.getItem("season") || "s3";
seasonSelect.value = savedSeason;

// è¼‰å…¥å°æ‡‰ç¶“é©—è¡¨
function loadExpTable(season) {
  submitBtn.disabled = true;
  submitBtn.textContent = "âœ¨ æ­£åœ¨è¼‰å…¥ç¶“é©—è¡¨â€¦ âœ¨";
  EXP_TABLE.clear();
  fetch(`static/database/exp_${season}.csv`)
    .then(res => res.text())
    .then(text => {
      text.trim().split(/\r?\n/).slice(1).forEach(line => {
        const [lv, exp] = line.split(',').map(Number);
        if (!isNaN(lv) && !isNaN(exp)) EXP_TABLE.set(lv, exp);
      });
      updatePrefixSum();
      console.log(`ç¶“é©—è¡¨ ${season.toUpperCase()} å·²è¼‰å…¥å®Œæˆï¼`);
      submitBtn.disabled = false;
      submitBtn.textContent = "âœ¨ é–‹å§‹è¨ˆç®— âœ¨";
    })
    .catch(err => {
      console.error('è®€å– CSV å¤±æ•—', err);
      submitBtn.textContent = "âš  è®€å–å¤±æ•—ï¼Œè«‹åˆ·æ–°";
    });
}

// åˆæ¬¡è¼‰å…¥
loadExpTable(savedSeason);

// ç•¶è³½å­£æ”¹è®Šæ™‚
seasonSelect.addEventListener("change", e => {
  const season = e.target.value;
  localStorage.setItem("season", season); // å„²å­˜åˆ° localStorage
  loadExpTable(season);                    // é‡æ–°è¼‰å…¥ CSV
});


</script>
</body>
</html>
